function toBigEndian(t,e){var i=new Array;return t.toString(16).match(/.{1,2}/g).map(t=>{var e=Number("0x"+t);i.push(e)}),i}function numbersToBuffer(t){return new Int8Array(t)}function debug(t,e=!0){let i=Array.prototype.map.call(new Uint8Array(t),t=>("00"+t.toString(16)).slice(-2)).join("-");return e&&console.log(i),i}function getBitInByte(t,e){return t&1<<e-1}var ReportMode={RUMBLE:16,PLAYER_LED:17,DATA_REPORTING:18,IR_CAMERA_ENABLE:19,SPEAKER_ENABLE:20,STATUS_INFO_REQ:21,MEM_REG_WRITE:22,MEM_REG_READ:23,SPEAKER_DATA:24,SPEAKER_MUTE:25,IR_CAMERA2_ENABLE:26},DataReportMode={CORE_BUTTONS:48,CORE_BUTTONS_AND_ACCEL:49,CORE_BUTTONS_ACCEL_IR:51},InputReport={STATUS:32,READ_MEM_DATA:33,ACK:34},Rumble={ON:1,OFF:0},LEDS={ONE:16,TWO:32,THREE:64,FOUR:128},BUTTON_BYTE1=["DPAD_LEFT","DPAD_RIGHT","DPAD_DOWN","DPAD_UP","PLUS","","",""],BUTTON_BYTE2=["TWO","ONE","B","A","MINUS","","","HOME"],IRDataType={BASIC:1,EXTENDED:3,FULL:5},RegisterType={EEPROM:0,CONTROL:4},IRSensitivity={LEVEL_1:[2,0,0,113,1,0,100,0,254],LEVEL_2:[2,0,0,113,1,0,150,0,180],LEVEL_3:[2,0,0,113,1,0,170,0,100],LEVEL_4:[2,0,0,113,1,0,200,0,54],LEVEL_5:[7,0,0,113,1,0,114,0,32],BLOCK_1:[253,5],BLOCK_2:[179,4],BLOCK_3:[99,3],BLOCK_4:[53,3],BLOCK_5:[31,3]};window.connectWiimote=function(){return new Promise(async(t,e)=>{const i=await navigator.hid.requestDevice({filters:[{vendorId:1406}]});device=i[0],t(device)})},window.WIIMote=class{constructor(t){this.device=t,this.buttonStatus={DPAD_LEFT:!1,DPAD_RIGHT:!1,DPAD_DOWN:!1,DPAD_UP:!1,PLUS:!1,TWO:!1,ONE:!1,B:!1,A:!1,MINUS:!1,HOME:!1},this.ledStatus=[!1,!1,!1,!1],this.rumblingStatus=!1,this.IrListener=null,this.AccListener=null,this.BtnListener=null,setTimeout(this.initiateDevice(),200)}initiateDevice(){this.device.open().then(()=>{this.sendReport(ReportMode.STATUS_INFO_REQ,[0]),this.setDataTracking(DataReportMode.CORE_BUTTONS),this.device.oninputreport=(t=>this.listener(t))})}initiateIR(t=IRDataType.EXTENDED,e=IRSensitivity.LEVEL_3,i=IRSensitivity.BLOCK_3){this.sendReport(ReportMode.IR_CAMERA_ENABLE,[4]),this.sendReport(ReportMode.IR_CAMERA2_ENABLE,[4]),this.writeRegister(RegisterType.CONTROL,11534384,[8]),this.writeRegister(RegisterType.CONTROL,11534336,e),this.writeRegister(RegisterType.CONTROL,11534362,i),this.writeRegister(RegisterType.CONTROL,11534387,[t]),this.writeRegister(RegisterType.CONTROL,11534384,[8]),this.setDataTracking(DataReportMode.CORE_BUTTONS_ACCEL_IR)}sendReport(t,e){return this.device.sendReport(t,numbersToBuffer(e)).catch(console.log)}toggleRumble(){var t=Rumble.ON;this.rumblingStatus?(t=Rumble.OFF,this.rumblingStatus=!1):this.rumblingStatus=!0,this.sendReport(ReportMode.RUMBLE,[t])}LedEncoder(t,e,i,r){return+Boolean(t)*LEDS.ONE+ +Boolean(e)*LEDS.TWO+ +Boolean(i)*LEDS.THREE+ +Boolean(r)*LEDS.FOUR}toggleLed(t){return this.ledStatus[t]=!this.ledStatus[t],this.sendReport(ReportMode.PLAYER_LED,[this.LedEncoder(...this.ledStatus)])}writeRegister(t,e,i){let r=toBigEndian(e,3),s=i.length;for(let t=0;t<16-s;t++)i.push(0);var n=[t,...r,s,...i];this.sendReport(ReportMode.MEM_REG_WRITE,n)}setDataTracking(t=DataReportMode.CORE_BUTTONS_ACCEL_IR){return this.sendReport(ReportMode.DATA_REPORTING,[0,t])}ACCDecoder(t){null!=this.AccListener&&this.AccListener(...t)}IRDecoder(t){var e=[];for(let n=0;n<12;n+=3)if(255!=t[n]&&255!=t[n+1]&&255!=t[n+2]){var i=t[n],r=t[n+1],s=t[n+2];i|=(48&s)<<4,r|=(192&s)<<2,e.push({x:i,y:r,s:s})}null!=this.IrListener&&this.IrListener(e)}toggleButton(t,e){""!=t&&null!=t&&(this.buttonStatus[t]=0!=e)}BTNDecoder(t,e){for(let i=0;i<8;i++){let r=getBitInByte(t,i+1),s=getBitInByte(e,i+1);this.toggleButton(BUTTON_BYTE1[i],r),this.toggleButton(BUTTON_BYTE2[i],s),null!=this.BtnListener&&this.BtnListener(this.buttonStatus)}}listener(t){var e=new Uint8Array(t.data.buffer);const[i,r,s,n,o,R,E,T,a,_,L,u,A,O,D,h,l]=e;t.reportId==InputReport.STATUS&&(console.log(e),this.setDataTracking(DataReportMode.CORE_BUTTONS_ACCEL_IR)),this.BTNDecoder(i,r),this.ACCDecoder([s,n,o]),this.IRDecoder([R,E,T,a,_,L,u,A,O,D,h,l])}};
